<!DOCTYPE html>
<html lang="en">
<head>
    <!-- <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="import" href="component.html">
    <link rel="manifest" href="manifest.json"> -->
    <title>Dashboard</title>
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"/>  -->
        <!-- <style>
        body {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 1.5rem;
        background-image:linear-gradient(#1f7d5f, whitesmoke);
         
 }

  h1 {
    color: rgba(168, 227, 250, 0.955)
 }


 .responsive {
	width:30%;
	height: auto;
   display: block;
   margin: auto;
   background-color: transparent;
} 


 h2 {  
     text-align: center;
     color: orange; 
 }

 p {
      text-align: center;
        color: #777777;
        margin-bottom: 3em;
 }

  input {
     font: inherit;
     width:fit-content; 
 } 

 html {
    scroll-behavior:smooth;
}


  h5 {
        color: orange;
 }

     
 /* .input-gender {
   color: #1f7d5f;
 }

 .gender {
   width: 10%;
 } */


  .container {
     width:100%;
     height: 70vh;
     background: none;
     display:inline-block;
     align-items: center;
     justify-content: center; 
     text-align: center;
     
 }  

  .container form {
        display: block;
        margin: auto;
        width: 420px; 
        padding: 10px 30px 20px; 
        border-radius: 4px; 
        box-shadow: 10px 20px 20px rgba(0, 0, 0, 0.5);
        position: relative;  
        background:#1f7d5f; 
        color: #fff;  
 }   

  .fa-paper-plane {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translate(-50%, -50%);
    background:orange;
    color: #1f7d5f;
    font-size: 30px;
    padding: 15px;
    border-radius: 50%;
    box-shadow: 0 0 10px(0, 0, 0, 0.5);
 } 
   

 .input-group {
    width: 100%;
    display: block;
    align-items: center; 
    margin: 10px auto 0;
    position: relative;
}  

 .input-group label {
    flex-basis: 20%;
    display:block ;
     font-size: 16px;
      color: whitesmoke; 
 }  

  .input-group input, .input-group textarea {
       flex-basis: 68%;
       background: transparent;
       border: 0;
       outline: 0;
       padding: 2px 0;
       border-bottom: 1px solid #999;
       color:chartreuse;
       font-size: 16px;
       width: 100%;
      /* position:relative;   */
 }  

   ::placeholder {
    font-size: 16px;
    color: wheat;
    
    /* text-align:left; */
 }

  form button {
        background-color: orange;
        color: white; 
        border-radius: 4px;
        border: none ;
        padding: 10px 40px; 
        outline: 0;
        cursor: pointer;
        display: block; 
        margin: auto
 }

  .input-group span {
       position:absolute;
       bottom: 12px;
       right: 17px;
       font-size: 14px;
       color: red;
 }

  #submit-error {
     color: red;
 }

  /* .input-group span i {
    color:red;
 }   */

  .btn:hover {
        background-color: #1f7d5f;
        color: white;
       } 
  h6 {
    color: #333;
 }

  .content .nowrap {
         display: block;
         margin: auto;
         position:sticky;
         bottom: O;
         padding-bottom: 0.7em;
			font-size: 0.9em;
			color: #1f7d5f;
           }

  
         
        </style> -->
<style>
    body { margin: 0;  padding: 0; box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; font-size: 1.5rem; background-color: #333; color: whitesmoke; }
    img { width: 150px; height: auto; padding-top: 0; padding-top: px; }
    .fa-google { color: red }
    .fa-arrow-right-from-bracket {  color: whitesmoke; }
    h1 {  text-align: center; }
    h3 { text-align: right;  margin-top: 5vh; margin-right: 5vh; }
    p { text-align: center; }
    ul { display: flex;  margin: 20px; justify-content: space-evenly; }
    button { display: block; margin:auto; font: inherit; width: 20%; height:auto; color: whitesmoke; justify-content: center;  border-radius: 5px;  background-color: orange;  border: none; }
    h4 { text-align: center; }
    h6 { text-align: center; }
</style>
</head>
 <body> 
  <br>
    <button id="logout-btn">Log out</button> 
    <h1>Welcome to Your Dashboard</h1> 
    <p>You're now securely logged in.</p>
    <div id="profile-container"></div>
    
    <p>Loading User info/profile...<a href="#"><i class="fa-solid fa-arrow-right-from-bracket"></i></a>  </p>
   <ul class="list">
     <img src="../img/SVGLogo.svg" alt="">

    <!-- <i class="fa-brands fa-google"></i>-->

   

</ul>  

<h2 style="text-align: center;">How can I help you?</h2>
<h3 style="text-align: center;">You are about to make an order of IdyllAc card. <br> To do that: Provide your Personal Information and quiers: <br> "Fill the Form, upload documents, take selfie" and send. Use the link below.</h3>

<p style="text-align: center;"><a href="/submit/personal_info" class="btn">Continue to Personal Info Form</a></p> 
</div>

<script>
    async function refreshAccessToken() {
      const refreshToken = localStorage.getItem('refreshToken');
      if (!refreshToken) {
        window.location.href = '/login';
        return;
      }
    
      const res = await fetch('https://anypay.cards/auth/refresh-token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: refreshToken })
      });
    
      const data = await res.json();
    
      if (res.ok) {
        localStorage.setItem('accessToken', data.accessToken);
        return data.accessToken;
      } else {
        console.error('Failed to refresh token:', data.message);
        window.location.href = '/login'; // fallback
      }
    }
    
    // Load dashboard info
    async function loadDashboard() {
      let accessToken = localStorage.getItem('accessToken');
      
      if (!accessToken) {
        accessToken = await refreshAccessToken();
      }
    
      const res = await fetch('https://anypay.cards/auth/dashboard', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${accessToken}` // 'Bearer ' + accessToken
        }
      });
    
      if (res.ok) {
        const data = await res.json();
        document.getElementById('profile-container').innerHTML = `
          <h2>Hello, ${data.user.name}</h2>
          <p>Email: ${data.user.email}</p>
          <p>User ID: ${data.user.id}</p>`;
      } else if (res.status === 401) {
        // Try one refresh and retry fetch
        const newToken = await refreshAccessToken();
        if (newToken) { 
          return loadDashboard(); // retry once
        } else {
          window.location.href = '/login';
        }
      } else {
        alert('Failed to load dashboard');
      }
    }
    
    // Call on page load
    loadDashboard();
    
    // Optional: Auto-refresh access token every 14 minutes
    setInterval(refreshAccessToken, 14 * 60 * 1000);
    </script>

    <!-- <button id="logout-btn">Log out</button> -->
    <script>
      document.getElementById('logout-btn').addEventListener('click', async () => {
        const refreshToken = localStorage.getItem('refreshToken');
    
        if (refreshToken) {
          // Call backend to invalidate refresh token
          await fetch('https://anypay.cards/auth/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: refreshToken })
          });
        }
    
        // Clean local storage
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
    
        // Redirect to login
        window.location.href = '/login';
      });
    </script>
    <script src="/js/dashboard.js"></script> <!-- âœ… Link the file -->
    
    

<footer class="footer">
    <h4> <span class="nowrap">Copyrights &copy;<time id="year"></time></span>
        <span class="nowrap">IdyllAc</span>
    </h4>
</footer> 

<script src="./server.js"></script>
<script src="https://kit.fontawesome.com/283a7ae800.js" crossorigin="anonymous"></script>

 </body>
 </html> 



 
